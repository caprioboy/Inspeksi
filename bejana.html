<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspeksi Bejana Tekan</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background-color: #f0f0f0; }
        
        /* TOMBOL KEMBALI */
        .btn-back { display: inline-block; background-color: #e2e6ea; color: #084B66; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 0.85rem; margin-bottom: 15px; border: 1px solid #ccc; }
        .btn-back:active { background-color: #dbe2e8; }

        .header { background-color: #084B66; color: white; text-align: center; padding: 15px; font-weight: bold; margin-bottom: 20px; border: 2px solid #000; }
        .logo-img { max-width: 100px; height: auto; display: block; margin: 0 auto 10px auto; background-color: white; padding: 5px; border-radius: 5px; }
        .sub-header { font-size: 0.9rem; margin-bottom: 5px; font-weight: normal; text-transform: uppercase; }
        .cn-text-header { font-size: 0.8rem; opacity: 0.8; font-weight: normal; display: block; }
        .general-info { background: white; padding: 15px; border: 2px solid #084B66; margin-bottom: 20px; border-radius: 5px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #084B66; }
        .cn-label { font-weight: normal; color: #666; font-size: 0.85rem; margin-left: 5px; } 
        .form-control { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 10px; gap: 5px; }
        .label-box { background-color: #084B66; color: white; padding: 10px; border: 2px solid #000; flex: 2; display: flex; flex-direction: column; justify-content: center; font-size: 0.75rem; line-height: 1.2; }
        .cn-item { color: #ccc; font-size: 0.7rem; display: block; margin-top: 2px; } 
        .input-box { background-color: #084B66; color: white; border: 2px solid #000; flex: 2; padding: 10px; font-size: 0.9rem; }
        .btn-foto-wrapper { background-color: #084B66; border: 2px solid #000; flex: 1; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .btn-text { color: white; text-decoration: underline; font-weight: bold; font-size: 0.8rem; text-align: center; line-height: 1.1; }
        .file-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .foto-ok { background-color: #28a745 !important; } 
        .btn-submit { width:100%; padding: 15px; margin-top:20px; background: #084B66; color: white; font-weight: bold; border:none; cursor:pointer; font-size: 1rem; }
        .btn-submit:disabled { background: #ccc; }

        /* TAMPILAN SUKSES & DOWNLOAD PDF */
        #success-container { display: none; text-align: center; padding: 20px; background: white; border: 2px solid #28a745; border-radius: 10px; margin-top: 20px; }
        .btn-download { display: block; width: 90%; margin: 10px auto; background-color: #d9534f; color: white; padding: 15px; text-decoration: none; font-weight: bold; border-radius: 5px; border: 2px solid #000; }
        .btn-new { display: block; width: 90%; margin: 10px auto; background-color: #084B66; color: white; padding: 15px; text-decoration: none; font-weight: bold; border-radius: 5px; border: 2px solid #000; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-back">&larr; Kembali ke Menu (è¿”å›ä¸»èœå•)</a>

    <div class="header">
        <img src="logo.png" alt="Logo ERM" class="logo-img">
        <div class="sub-header">Departemen Pengujian Peralatan Khusus ERM <span class="cn-text-header">ERM ç‰¹ç§è®¾å¤‡æ£€æµ‹éƒ¨</span></div>
        Inspeksi Bejana Tekan <span class="cn-text-header">å‹åŠ›å®¹å™¨æ£€éªŒ</span>
    </div>

    <div id="success-container">
        <h2 style="color:#28a745;">Laporan Terkirim! <br><span style="font-size:0.8rem;">æäº¤æˆåŠŸ</span></h2>
        <p>Data sudah disimpan ke Excel.</p>
        
        <a id="link-download" href="#" class="btn-download" target="_blank">
            ğŸ“¥ DOWNLOAD PDF LAPORAN <br>
            <span style="font-size:0.8rem; font-weight:normal;">ä¸‹è½½ PDF æŠ¥å‘Š</span>
        </a>

        <a href="javascript:location.reload()" class="btn-new">
            Isi Form Baru (å¡«æ–°è¡¨)
        </a>
    </div>

    <form id="formInspeksi">
        <div class="general-info">
            <div class="form-group"><label>Perusahaan <span class="cn-label">å…¬å¸</span></label><input type="text" id="pt" class="form-control" placeholder="Contoh: PT. IMIP"></div>
            <div class="form-group"><label>Departemen <span class="cn-label">éƒ¨é—¨</span></label><input type="text" id="departemen" class="form-control" placeholder="Contoh: Utilities"></div>
            <div class="form-group"><label>Area <span class="cn-label">åŒºåŸŸ</span></label><input type="text" id="area" class="form-control" placeholder="Contoh: Smelter A"></div>
            <div class="form-group"><label>Nomor Unit <span class="cn-label">è®¾å¤‡ç¼–å·</span></label><input type="text" id="unit" class="form-control" placeholder="Contoh: COMP-01"></div>
            <div class="form-group"><label>Nama Penguji <span class="cn-label">æ£€éªŒå‘˜</span></label><input type="text" id="penguji" class="form-control" placeholder="Nama Anda"></div>
        </div>

        <div class="item-row" data-label="Korosi Badan Bejana"><div class="label-box"><b>Korosi pada Badan Bejana</b><span class="cn-item">ç½ä½“è…èš€</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Nameplate"><div class="label-box"><b>Nameplat tdk jelas/tdk ada</b><span class="cn-item">é“­ç‰Œæ¨¡ç³Šã€ç¼ºå¤±</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Tanda Arah Aliran"><div class="label-box"><b>Pipa inlet/outlet tdk ada arah aliran</b><span class="cn-item">è¿›å‡ºå£ç®¡é“æœªæ ‡æ˜ä»‹è´¨æµå‘</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Lapisan Anti Korosi"><div class="label-box"><b>Lapisan anti korosi rusak</b><span class="cn-item">è¿›å‡ºå£ç®¡é“æœªä½œé˜²è…æˆ–é˜²è…å±‚æŸå</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Penyangga Pipa"><div class="label-box"><b>Penyangga pipa longgar/rusak</b><span class="cn-item">è¿›å‡ºå£ç®¡é“æ”¯æ¶æ¾åŠ¨ã€æŸå</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Penyangga Tangki"><div class="label-box"><b>Peyangga tangki longgar/rusak</b><span class="cn-item">ç½ä½“æ”¯åº§æ¾åŠ¨ã€æŸå</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Perawatan Katup"><div class="label-box"><b>Katup pipa tdk dirawat</b><span class="cn-item">è¿›å‡ºå£ç®¡é“é˜€é—¨æœªè¿›è¡Œç»´æŠ¤ä¿å…»</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Cek Pressure Gauge"><div class="label-box"><b>Pressure gauge tdk diperiksa berkala</b><span class="cn-item">å‹åŠ›è¡¨æœªå®šæœŸæ•ˆéªŒ</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Katup Pressure Gauge"><div class="label-box"><b>Tdk ada katup di Pressure gauge</b><span class="cn-item">å‹åŠ›è¡¨ä¸ç½ä½“ä¹‹é—´æœªè£…è®¾é˜€é—¨</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>
        <div class="item-row" data-label="Cek Safety Valve"><div class="label-box"><b>Safety valve tdk diperiksa berkala</b><span class="cn-item">å®‰å…¨é˜€æœªå®šæœŸæ•ˆéªŒ</span></div><input type="text" class="input-box" placeholder="Keterangan (å¤‡æ³¨)"><label class="btn-foto-wrapper"><span class="btn-text">FOTO<br><span style="font-size:0.6rem; font-weight:normal;">æ‹ç…§</span></span><input type="file" class="file-input" accept="image/*" onchange="tandaiFoto(this)"></label></div>

        <button type="button" id="btnKirim" onclick="kirimData()" class="btn-submit">
            KIRIM DATA <br> <span style="font-size:0.8rem; font-weight:normal;">æäº¤æ•°æ®</span>
        </button>
        <p id="status" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
    </form>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxSNOkC20sE-XF_6D5oRO9DAk_2T1zTZQbNscR03sSCmOZreTMPzkVedrmoDOvZKg_U4A/exec"; 
        const KODE_RAHASIA = "IMIP_AMAN_2026";

        function tandaiFoto(input) {
            if(input.files && input.files[0]) {
                input.parentElement.classList.add('foto-ok');
                input.parentElement.querySelector('.btn-text').innerText = "OK";
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function kirimData() {
            const btn = document.getElementById('btnKirim');
            const status = document.getElementById('status');
            const pt = document.getElementById('pt').value;
            const dept = document.getElementById('departemen').value;
            const unit = document.getElementById('unit').value;
            const penguji = document.getElementById('penguji').value;

            if(!pt || !dept || !unit || !penguji) { alert("Mohon lengkapi Data Umum dulu!"); return; }

            btn.disabled = true; btn.innerText = "Memproses PDF (æ­£åœ¨å¤„ç†)..."; status.innerText = "Mohon tunggu, sedang membuat PDF...";

            let dataPaket = {
                token: KODE_RAHASIA,
                jenis_alat: "Bejana", 
                pt: pt,
                departemen: dept,
                area: document.getElementById('area').value,
                unit: unit,
                penguji: penguji,
                items: []
            };

            const rows = document.querySelectorAll('.item-row');
            for (let row of rows) {
                const label = row.getAttribute('data-label');
                const keterangan = row.querySelector('.input-box').value;
                const fileInput = row.querySelector('.file-input');
                let imageBase64 = "";
                if (fileInput.files.length > 0) {
                    try { imageBase64 = await toBase64(fileInput.files[0]); } catch (e) {}
                }
                dataPaket.items.push({ label: label, keterangan: keterangan || "-", image: imageBase64 });
            }

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(dataPaket)
            })
            .then(res => res.json()) // UBAH KE JSON
            .then(response => {
                if(response.result === "success") {
                    // SEMBUNYIKAN FORM
                    document.getElementById('formInspeksi').style.display = 'none';
                    // TAMPILKAN WADAH SUKSES
                    document.getElementById('success-container').style.display = 'block';
                    // PASANG LINK DOWNLOAD PDF
                    document.getElementById('link-download').href = response.pdfUrl;
                } else {
                    alert("Gagal: " + response.error);
                    btn.disabled = false; btn.innerText = "KIRIM DATA"; status.innerText = "Gagal.";
                }
            })
            .catch(err => {
                console.error(err);
                alert("Gagal kirim. Cek internet.");
                btn.disabled = false; btn.innerText = "KIRIM DATA"; status.innerText = "Gagal.";
            });
        }
    </script>
</body>
</html>
